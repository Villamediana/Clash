<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>BaseadoemFatos â€“ Player</title>
  <link rel="icon" href="/static/logo.png" type="image/png">

  <!-- Font & libs -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>

  <!-- === ESTILO ======================================================= -->
  <style>
  /* PALETA */
  :root{
    --bg:#0f0a07;                   /* fundo escuro quente */
    --card:rgba(255,255,255,.05);
    --glass:rgba(255,255,255,.10);
    --fg:#f5f6fa;
    --muted:#c8b7a6;                /* tom quente */
    --accent0:#f59e0b;              /* Ã¢mbar */
    --accent1:#ef4444;              /* vermelho */
    --radius:14px;
    --gap:1rem;
    --t:.25s cubic-bezier(.4,.0,.2,1);
  }

  /* RESET & BASE */
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
  html{scrollbar-width:thin;scrollbar-color:var(--accent1) var(--glass);}
  html::-webkit-scrollbar{width:8px;}
  html::-webkit-scrollbar-track{background:var(--glass);}
  html::-webkit-scrollbar-thumb{background:linear-gradient(180deg,var(--accent1),var(--accent0));border-radius:6px;}
  body{
    font-family:Inter,system-ui,sans-serif;
    background:var(--bg);
    color:var(--fg);
    line-height:1.5;
  }

  /* CONTAINER & HEADER */
  .wrapper{max-width:1200px;margin:auto;padding:calc(var(--gap)*1.5);}
  header{position:static;top:auto;z-index:auto;padding:var(--gap) 0;background:var(--bg);} 
  h1{font-size:2.2rem;text-align:center;color:var(--fg);margin-bottom:var(--gap);}
  @media(max-width:480px){h1{font-size:1.6rem;}}

  /* CONTROLS */
  .controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:var(--gap);margin-bottom:var(--gap);}
  input,select,button{
    width:100%;padding:.75rem 1rem;font-size:1rem;border-radius:var(--radius);
    font:inherit;border:1px solid var(--glass);background:var(--glass);color:var(--fg);
    backdrop-filter:blur(6px);outline:none;
  }
  #searchInput{display: none;}
  select{appearance:none;}
  select option{background:var(--bg);color:var(--fg);}
  button{
    background:linear-gradient(90deg,var(--accent0),var(--accent1));
    color:#0d0d15;font-weight:600;border:none;cursor:pointer;
    transition:transform var(--t),box-shadow var(--t);
    box-shadow:0 4px 12px rgba(239,68,68,.35);
  }
  button:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(239,68,68,.45);} 

  /* CARTÃ•ES GENÃ‰RICOS */
  .card-block{
    background:var(--card);border-radius:var(--radius);padding:var(--gap);
    box-shadow:0 4px 10px rgba(0,0,0,.25);position:relative;
  }
  .card-block::before{
    content:"";position:absolute;inset:0;border-radius:inherit;padding:1px;
    background:linear-gradient(135deg,transparent 0%,var(--accent1) 50%,transparent 100%);
    -webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);
    -webkit-mask-composite:xor;mask-composite:exclude;pointer-events:none;
  }
  h2.title{margin-bottom:var(--gap);font-size:1.3rem;font-weight:700;color:var(--fg);}

  /* ESTAT & CHART */
  .stats p{margin-bottom:.5rem;color:var(--muted);}
  .chart-container{
  width:100%;
  aspect-ratio:2/1;   /* 2â€¯Ã—â€¯1 mantÃ©m a proporÃ§Ã£o */
  margin:var(--gap) 0;
  position:relative;  /* permite o canvas ocupar tudo */
}
#winLossChart{
  width:100% !important;
  height:100% !important;   /* preenche o container */
}
  /* GRID BATALHAS */
  .batalhas{display:grid;grid-template-columns:repeat(auto-fit,minmax(330px,1fr));gap:var(--gap);}
  .match-card{transition:transform var(--t),box-shadow var(--t);}
  .match-card:hover{transform:translateY(-4px);box-shadow:0 6px 20px rgba(0,0,0,.35);}
  .match-card.win{background:rgba(245,158,11,.14);} 
  .match-card.lose{background:rgba(239,68,68,.16);} 
  .arena-info{text-align:center;padding:var(--gap) var(--gap) .75rem;border-bottom:1px solid var(--glass);}
  .arena-info h3{font-size:1.1rem;color:var(--fg);}
  .arena-info span{display:block;font-size:.85rem;color:var(--muted);}
  .match{display:flex;flex-wrap:wrap;gap:var(--gap);padding:var(--gap) .75rem;justify-content:center;}
  .player-info{
    flex:1 1 150px;background:var(--glass);border-radius:var(--radius);
    padding:var(--gap);text-align:center;
  }
  .player-info h4{margin-bottom:.35rem;font-size:1rem;color:var(--fg);}
  .player-info p{margin-bottom:.75rem;font-size:.85rem;color:var(--muted);}

  /* CHIPS (cartas) */
  .deck{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;}
  .card{
    background:var(--card);border:1px solid var(--accent1);color:var(--fg);
    padding:.45rem .7rem;font-size:.8rem;border-radius:8px;font-weight:600;
  }
  .versus{align-self:center;font-size:1.6rem;font-weight:700;color:#ef4444;}

  /* FunÃ§Ãµes visuais para cargos com gradiente animado, mais suave */
  .coleader{font-weight:700;
    background:linear-gradient(90deg,var(--accent0),#afffcb,var(--accent1));
    -webkit-background-clip:text;color:transparent;background-size:300% 100%;
    background-position:0% 50%;
    animation:roll 6s linear infinite;text-shadow:0 0 6px rgba(78,255,183,.6);
  }
  .leader{font-weight:700;
    background:linear-gradient(90deg,#fcd34d,#f59e0b,#fcd34d);
    -webkit-background-clip:text;color:transparent;background-size:250% 100%;
    background-position:0% 50%;
    animation:roll 8s linear infinite;text-shadow:0 0 8px rgba(255,215,0,.7);
  }
  @keyframes roll{
    0%{background-position:0% 50%;}
    100%{background-position:100% 50%;}
  }

  /* LISTAS EXTRAS */
  .cards-list{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;}
  .dica{background:#224e36;color:#afffcb;padding:.6rem;border-radius:var(--radius);
        margin-top:var(--gap);font-size:.9rem;}

  /* MOBILE */
  @media(max-width:480px){.player-info{flex:1 1 100%;}}

  /* OCULTOS (remova se precisar exibir) */
  #savedTags,#playerTag,#batalhas{display:none}
  </style>
</head>
<body>
  <div class="wrapper">
    <header><h1 id="title">EstatÃ­sticas de batalha</h1></header>

    <!-- CONTROLES -->
    <div class="controls">
      <select id="savedTags"><option value="">â€” Tags salvas â€”</option></select>
      <input  id="playerTag"   type="text" placeholder="Tag do jogador (#ABC123)">
      <select id="typeFilter"><option value="">â€” Todos os tipos â€”</option></select>
      <button onclick="init()">ğŸ”„Â Carregar</button>
      <input  id="searchInput" type="text" placeholder="Pesquisar arena ou oponenteâ€¦">
    </div>

    <!-- ESTATÃSTICAS -->
    <section id="estatisticas" class="card-block">
      <h2 class="title">ğŸ“ŠÂ EstatÃ­sticas</h2>
      <div id="estatisticasContent" class="stats">Carregando estatÃ­sticasâ€¦</div>
    </section>

    <!-- CHART -->
    <section class="card-block chart-container">
      <h2 class="title">ğŸ“ˆÂ EvoluÃ§Ã£oÂ VitÃ³ria Vs Derrota</h2>
      <canvas id="winLossChart"></canvas>
    </section>

    <!-- GRID BATALHAS -->
    <div class="batalhas" id="batalhas"></div>

    <!-- DECK PERFEITO -->
    <section class="card-block" style="display:none">
      <h2 class="title">ğŸ†Â DeckÂ PerfeitoÂ (dosÂ oponentes)</h2>
      <div class="cards-list" id="deckPerfeito"></div>
    </section>

    <!-- CARTAS SOFRIMENTO -->
    <section id="cartasSofrimento" class="card-block">
      <h2 class="title">ğŸ’£Â Cartas que mais causaram derrotas</h2>
      <div id="cartasQueMaisDoeu"></div>
    </section>
  </div>

  <!-- === JAVASCRIPT ORIGINAL (sÃ³ ajustes mÃ­nimos de cor & Ã­cone) ====== -->
  <script>
const STORAGE_KEY='clashSavedTags';
let todasBatalhas=[];
let winLossChart;

// TraduÃ§Ã£o InglÃªs â†’ PortuguÃªs
const CARD_NAMES_PT={
  "Archers":"Arqueiras","Archer Queen":"RainhaÂ Arqueira","Baby Dragon":"BebÃªÂ DragÃ£o",
  "Balloon":"BalÃ£o","Bandit":"Bandida","Barbarians":"BÃ¡rbaros","Bats":"Morcegos",
  "Battle Healer":"CurandeiraÂ deÂ Batalha","Battle Ram":"ÃriesÂ deÂ Batalha","Berserker":"Berserker",
  "Bomber":"Bombardeiro","Bowler":"LanÃ§ador","Cannon Cart":"CarroÃ§aÂ deÂ CanhÃ£o",
  "Dark Prince":"PrÃ­ncipeÂ Negro","Dart Goblin":"GoblinÂ Arqueiro","Electro Wizard":"MagoÂ ElÃ©trico",
  "Elite Barbarians":"BÃ¡rbarosÂ deÂ Elite","Executioner":"Carrasco","Fire Spirit":"EspÃ­ritoÂ deÂ Fogo",
  "Flying Machine":"MÃ¡quinaÂ Voadora","Giant":"Gigante","Giant Skeleton":"EsqueletoÂ Gigante",
  "Goblin Gang":"GangueÂ deÂ Goblins","Goblin Barrel":"BarrilÂ deÂ Goblins","Guards":"Guardas",
  "Hog Rider":"CorredorÂ deÂ Porcos","Ice Spirit":"EspÃ­ritoÂ deÂ Gelo","Ice Wizard":"MagoÂ deÂ Gelo",
  "Inferno Dragon":"DragÃ£oÂ Infernal","Knight":"Cavaleiro","Lava Hound":"HoundÂ deÂ Lava",
  "Mega Minion":"MegaÂ Servo","Miner":"Mineiro","Mini P.E.K.K.A.":"MiniÂ P.E.K.K.A.",
  "Minion Horde":"HordaÂ deÂ Servos","P.E.K.K.A.":"P.E.K.K.A.","Princess":"Princesa",
  "Prince":"PrÃ­ncipe","Ram Rider":"CavaleiraÂ deÂ Carneiro","Royal Ghost":"FantasmaÂ Real",
  "Royal Giant":"GiganteÂ Real","Skeleton Army":"ExÃ©rcitoÂ deÂ Esqueletos",
  "Skeleton Barrel":"BarrilÂ deÂ Esqueletos","Spear Goblins":"GoblinsÂ Lanceiros",
  "Three Musketeers":"TrÃªsÂ Mosqueteiras","Valkyrie":"ValquÃ­ria","Witch":"Bruxa",
  "Wizard":"Mago","Zappies":"Eletrocutadores",
  "Firecracker":"Pirotecnia",
  "The Log":"Tronco",
  "Royal Recruits":"Recrutas Reais",
  "Cannon":"CanhÃ£o",
};
const translateCard=n=>CARD_NAMES_PT[n]||n;

function prefillFromURL(){
  const p=new URLSearchParams(location.search);const tag=p.get('tag');
  if(tag) document.getElementById('playerTag').value=decodeURIComponent(tag);
}
function loadSavedTags(){
  const tags=JSON.parse(localStorage.getItem(STORAGE_KEY))||[];
  const sel=document.getElementById('savedTags');
  sel.innerHTML='<option value="">â€” Tags salvas â€”</option>'+tags.map(t=>`<option>${t}</option>`).join('');
  sel.onchange=()=>{document.getElementById('playerTag').value=sel.value;};
}
function saveTag(tag){
  let tags=JSON.parse(localStorage.getItem(STORAGE_KEY))||[];
  if(!tags.includes(tag)){tags.unshift(tag);localStorage.setItem(STORAGE_KEY,JSON.stringify(tags.slice(0,20)));}
}

function init() {
  let tag = document.getElementById('playerTag').value.trim();
  if (!tag) return alert('Informe a tag do jogador.');
  if (!tag.startsWith('#')) {
    tag = '#' + tag;
    document.getElementById('playerTag').value = tag;
  }

  saveTag(tag);
  loadSavedTags();

  fetch(`/api/historico?tag=${encodeURIComponent(tag)}`)
    .then(r => r.json())
    .then(data => {
      todasBatalhas = data.sort((a, b) => new Date(b.battleTime) - new Date(a.battleTime));

      // Atualiza o tÃ­tulo com o nome do jogador
      const playerName = data[0]?.team?.[0]?.name;
      if (playerName) {
        document.getElementById('title').textContent =
          `EstatÃ­sticas de batalha â€“ ${playerName}`;
      }

      populaDropdownTipos();
      applyFilters();

      // Atualiza o favicon se houver badgeUrl no clan
      if (data?.clan?.badgeUrl) {
        let favicon = document.querySelector("link[rel='icon']");
        if (!favicon) {
          favicon = document.createElement('link');
          favicon.rel = 'icon';
          document.head.appendChild(favicon);
        }
        favicon.href = data.clan.badgeUrl;
      }
    });
}



function populaDropdownTipos(){
  const sel=document.getElementById('typeFilter');
  const tipos=[...new Set(todasBatalhas.map(b=>b.type))];
  sel.innerHTML='<option value="">â€” Todos os tipos â€”</option>'+tipos.map(t=>`<option>${t}</option>`).join('');
  sel.onchange=applyFilters;
}

function applyFilters(){
  const termo=document.getElementById('searchInput').value.toLowerCase();
  const tipo=document.getElementById('typeFilter').value;
  const filtradas=todasBatalhas.filter(b=>{
    const okTipo=!tipo||b.type===tipo;
    const okBusca=b.arena.name.toLowerCase().includes(termo)||b.opponent[0].name.toLowerCase().includes(termo);
    return okTipo&&okBusca;
  });
  calcularEstatisticas(filtradas);
  renderBatalhas(filtradas);
  calcularDeckPerfeito(filtradas);
  renderChart(filtradas);
}

function renderBatalhas(list){
  const cont=document.getElementById('batalhas');
  if(!list.length){
    cont.innerHTML=`<div class="card-block"><div class="arena-info"><h3>Sem batalhas</h3><span>Nenhuma batalha.</span></div></div>`;
    return;
  }
  cont.innerHTML=list.map(b=>{
    const venceu=b.team[0].crowns>b.opponent[0].crowns;
    const cls=venceu?'win':'lose';
    const data=`${b.battleTime.slice(6,8)}/${b.battleTime.slice(4,6)}/${b.battleTime.slice(0,4)}`;
    const deck1=b.team[0].cards.map(c=>`<div class="card">${translateCard(c.name)}</div>`).join('');
    const deck2=b.opponent[0].cards.map(c=>`<div class="card">${translateCard(c.name)}</div>`).join('');
    return `<div class="card-block match-card ${cls}">
      <div class="arena-info"><h3>${b.arena.name}Â â€“Â ${b.gameMode.name}</h3><span>${data}</span></div>
      <div class="match">
        <div class="player-info"><h4>${b.team[0].name}</h4><p><strong>${b.team[0].startingTrophies}</strong>Â trofÃ©us</p><div class="deck">${deck1}</div></div>
        <div class="versus">VS</div>
        <div class="player-info"><h4>${b.opponent[0].name}</h4><p><strong>${b.opponent[0].startingTrophies}</strong>Â trofÃ©us</p><div class="deck">${deck2}</div></div>
      </div>
    </div>`;
  }).join('');
}

function calcularEstatisticas(list){
  const estat=document.getElementById('estatisticasContent');
  if(!list.length){estat.innerHTML='<p>Sem batalhas.</p>';document.getElementById('cartasQueMaisDoeu').innerHTML='';return;}
  let v=0,d=0,modos={},cartasS={};
  list.forEach(b=>{
    const t=b.team[0],o=b.opponent[0];
    if(t.crowns>o.crowns){v++;}else{d++;o.cards.forEach(c=>cartasS[c.name]=(cartasS[c.name]||0)+1);}
    modos[b.gameMode.name]=(modos[b.gameMode.name]||0)+1;
  });
  const modoMais=Object.keys(modos).reduce((a,b)=>modos[a]>modos[b]?a:b,'-');
  const winrate=Math.round((v/list.length)*100);
  estat.innerHTML=`<p><strong>Partidas:</strong>Â ${list.length}Â |Â <strong>VitÃ³rias:</strong>Â ${v}Â |Â <strong>Derrotas:</strong>Â ${d}</p>
                   <p><strong>Taxa de vitÃ³rias:Winâ€‘rate:</strong>Â ${winrate}%Â </p>`;
  const cartasPain=Object.entries(cartasS).sort((a,b)=>b[1]-a[1]).slice(0,8)
      .map(([n,q])=>`<div class="card">${translateCard(n)}Â (${q})</div>`).join('');
  document.getElementById('cartasQueMaisDoeu').innerHTML=cartasPain||'<p>Sem dados.</p>';
}

function calcularDeckPerfeito(list){
  const cont=document.getElementById('deckPerfeito');
  const freq={};
  list.forEach(b=>{
    if(b.opponent[0].crowns>b.team[0].crowns){
      const key=b.opponent[0].cards.map(c=>c.name).sort().join(',');
      freq[key]=(freq[key]||0)+1;
    }
  });
  const best=Object.entries(freq).sort((a,b)=>b[1]-a[1])[0];
  cont.innerHTML=best?best[0].split(',').map(n=>`<div class="card">${translateCard(n)}</div>`).join(''):'<p>Sem dados.</p>';
}

function renderChart(list){
  if(!list.length){winLossChart?.destroy();winLossChart=null;return;}
  const css=getComputedStyle(document.documentElement);
  const green=css.getPropertyValue('--accent0')||'#4ade80';
  const red='#ef4444',yellow='#facc15';
  const ordered=[...list].sort((a,b)=>new Date(a.battleTime)-new Date(b.battleTime));
  let cumW=0,cumL=0;const wins=[],losses=[],winRate=[];
  ordered.forEach((b,i)=>{
    const idx=i+1,win=b.team[0].crowns>b.opponent[0].crowns;
    win?cumW++:cumL++;wins.push({x:idx,y:cumW});losses.push({x:idx,y:cumL});winRate.push({x:idx,y:(cumW/idx)*100});
  });
  winLossChart?.destroy();
  winLossChart=new Chart(document.getElementById('winLossChart'),{
    type:'line',
    data:{datasets:[
      {label:'VitÃ³rias',data:wins,borderColor:green,backgroundColor:green,fill:false,tension:.1},
      {label:'Derrotas',data:losses,borderColor:red,backgroundColor:red,fill:false,tension:.1},
      {label:'Winâ€‘rateÂ %',data:winRate,borderColor:yellow,borderDash:[6,6],fill:false,pointRadius:0,yAxisID:'y2'}
    ]},
    options:{
      parsing:false,responsive:true,maintainAspectRatio:false,
      scales:{
        x:{type:'linear',title:{display:true,text:'Partida'}},
        y:{beginAtZero:true,title:{display:true,text:'Acumulado'}},
        y2:{position:'right',beginAtZero:true,min:0,max:100,grid:{drawOnChartArea:false},
            title:{display:true,text:'Winâ€‘rateÂ (%)'}}
      },
      plugins:{legend:{position:'bottom'}}
    }
  });
}

window.addEventListener('DOMContentLoaded',()=>{
  prefillFromURL();loadSavedTags();init();
  document.getElementById('searchInput').addEventListener('input',applyFilters);
});
  </script>
</body>
</html>
